<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MCS Demo</title>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            color: #292929;
            font: 90% Verdana, Arial, sans-serif;
            font-weight: 300;
        }

        p {
            padding: 0 10px;
            line-height: 1.8;
        }

        ul {
            list-style-type: none;
            margin: 10px;
            padding: 10px;
            height: 200px;
            width: 90%;
            overflow: hidden;
            overflow-y: scroll;
        }

        ul li a {
            display: block;
            width: 100%;
            text-decoration: none;
            padding: 5px;
            color: #072c3e;
            background-color: #98b8b9;
        }

        ul li a:hover {
            background-color: #ccc;
        }

        h3 {
            padding: 5px 20px;
            margin: 0;
        }

        div#header h1 {
            height: 80px;
            line-height: 80px;
            margin: 0;
            padding-left: 10px;
            background: #e0e0e0;
            color: #292929;
        }

        div#navigation {
            background: #7fa0a9;
        }

        div#navigation li {
            list-style: none;
        }

        div#extra {
            background: #7fa0a9;
        }

        div#footer {
            background: #42444e;
            color: #fff;
        }

        div#footer p {
            padding: 20px 10px;
        }

        div#wrapper {
            float: left;
            width: 100%;
        }

        div#content {
            margin: 0 25%;
            padding-right: 25px;
        }

        div#navigation {
            float: left;
            width: 20%;
            margin-left: -100%;
        }

        div#extra {
            float: left;
            width: 25%;
            margin-left: -25%;
        }

        div#footer {
            clear: left;
            width: 100%;
        }

        .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .overlay {
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            background: #ffffff;
            opacity: 70%;
        }

        .overlay-inner {
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            position: absolute;
        }

        .overlay-content {
            left: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .spinner {
            width: 120px;
            height: 120px;
            display: inline-block;
            animation: spin 2s infinite linear;
            border: 16px solid #f3f3f3;
            border-top: 16px solid #7fa0a9;
            border-radius: 50%;
        }

        /* Safari */
        @-webkit-keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .input_fields {
            display: flex;
            justify-content: space-between;
        }

        #validation_errors {
            display: block;
            color: red;
            font-size: 80%;
            min-height: 18px;
        }
    </style>
</head>

<body>
<div id="container">
    <div id="loading-spinner" class="overlay">
        <div class="overlay-inner">
            <div class="overlay-content"><span class="spinner"></span></div>
        </div>
    </div>
    <div id="header">
        <h1>MCS Demo</h1>
    </div>
    <div id="wrapper">
        <div id="content">
            <p><div id="scene_filename_div">
                <span>Scene: </span>
                <span id="scene_filename">None</span>
            </div></p>
            <p><div id="step_number_div">
                <span>Step: </span>
                <span id="step_number">N/A</span>
            </div></p>
            <p><div id="action_list_div">
                <span>Actions: </span>
                <span id="action_list">N/A</span>
            </div></p>
            <p><div id="goal_cat_div">
                <span>Goal Category: </span>
                <span id="goal_cat">N/A</span>
            </div></p>
            <p><div id="goal_desc_div">
                <span>Goal Description: </span>
                <span id="goal_desc">N/A</span>
            </div></p>
            <p><div id="goal_last_step_div">
                <span>Last Step: </span>
                <span id="goal_last_step">N/A</span>
            </div></p>
            <hr/>
            <p>
                <div>
                    Action Parameter Input Fields:
                </div>
            </p>
            <p>
                <div>
            Parameter(s) will be used if applicable for chosen keyboard shortcut, 
            see <a href="https://nextcenturycorporation.github.io/MCS/api.html#machine_common_sense.Action">Action API</a>
            for more information on parameters. If any of the inputs are not valid, an error message will be displayed,
            and your chosen action will not be processed until error(s) are resolved.</div>
            </p>
            <p>
                <div>
                    For image coordinates, the default is the center of the scene image. 
                    Click a point on the Unity image to populate with a different coordinate.
                </div>
            </p>
            <p><div id="image_coords_div">
                <span>Image Coordinates: (
                    x: <span id="image_coord_x">300</span>,
                    y: <span id="image_coord_y">200</span>
                )</span></div>
            </p>
            <p>
                <div class="input_fields">
                    <div>Amount: 
                        <input type="number" min="0" max="1" step="0.1" value="1" id="amount"/>
                    </div>
                    <div>Force: 
                        <input type="number" min="-1" max="1" step="0.1" value="0.5" id="force"/>
                    </div>
                    <div>Clockwise: 
                        <input type="checkbox" id="clockwise" checked>
                    </div>
                    <div>Lateral: 
                        <input type="number" min="-1" max="1" step="1" value="0" id="lateral"/>
                    </div>
                    <div>Straight: 
                        <input type="number" min="-1" max="1" step="1" value="1" id="straight"/>
                    </div>
                </div>
            </p>
            <span id="validation_errors"></span>
            <p></p>
            <img id="unityimg" width="600" height="400" src="{{ unityimg }}" alt="my image" class="center"/>
            <br/>
            <p></p>

        </div>
    </div>
    <div id="navigation">
        <p><strong>Scenes</strong></p>
        <p>Pick from one of the following scenes:</p>
        <ul id="scenes_unordered_list">
            {% for scene in scene_list %}
                <li>{{ scene }}</li>
            {% endfor %}
        </ul>

    </div>
    <div id="extra">
        <p><strong>Keyboard Shortcuts</strong></p>
        <p>Below are the keyboard shortcuts. Make sure your mouse is somewhere in the
            browser window and key strokes will be sent to the environment.</p>

        <img id="keyboard" width="400" src="static/keyboard.jpg" alt="keyboard" class="center"/>

        <p>The left part of the keyboard is for <strong>motion</strong>
            so that 'a' and 'd' make the agent move left or right without rotating.
            To <strong>rotate</strong> left and right, use 'j' and 'l' (lower case 'L') </p>
    </div>
    <div id="footer"><p>Footer</p>
    </div>
</div>
<script type="text/javascript">AddFillerLink("content", "navigation", "extra")</script>
<script src="https://unpkg.com/whatwg-fetch@2.0.4/fetch.js"></script>
<script>
    // ---------------------------------------------------------
    // Handle clicking on one of the scene file names
    var lis = document.getElementById("scenes_unordered_list").getElementsByTagName('li');
    let actionKeysWithParams = ['1', '3', '4', '5', '6', '7', '8', '9', 'm', 'M', 't', 'T']
    let arrowKeys = ["ArrowDown", "ArrowUp", "ArrowLeft", "ArrowRight"]
    var processingKeypress = false
    // default screen coordinates are in the center of image
    var params = {
        "objectImageCoordsX": 300,
        "objectImageCoordsY": 200
    }
    var hasValidInput = true
    loadingSpinner(false)
    loadController()

    for (var i = 0; i < lis.length; i++) {
        lis[i].addEventListener('click', select_scene, false);
    }

    function eventHandleScenes() {
        lis = document.getElementById("scenes_unordered_list").getElementsByTagName('li');
        for (var i = 0; i < lis.length; i++) {
            lis[i].addEventListener('click', select_scene, false);
        }

    }

    function loadController() {
        loadingSpinner(true)
        resp = fetch("{{url_for('handle_load_controller')}}",
            {method: 'POST', body: JSON.stringify(this.innerHTML)})
            .then(parseJsonResponse)
            .then(updateSceneList)
            .then(updateImage)
            .then(function() {
                loadingSpinner(false)
            });
    }

    function select_scene() {
        if(this.innerHTML == document.getElementById('scene_filename').innerHTML &&
            document.getElementById('step_number').innerHTML == "0") {
            console.log("Clicked scene is already selected and initialized. Returning...")
            return;
        }
        loadingSpinner(true)
        resp = fetch("{{url_for('handle_scene_selection')}}",
            {method: 'POST', body: JSON.stringify(this.innerHTML)})
            .then(parseJsonResponse)
            .then(updateSceneFilename)
            .then(updateStepNumber)
            .then(updateActionList)
            .then(updateGoalInfo)
            .then(clearImageCoordinates)
            .then(updateImage)
            .then(function() {
                loadingSpinner(false)
            });
    }

    function parseJsonResponse(response) {
        jsonPromise = response.json();
        return jsonPromise;
    }

    function updateActionList(data) {
        console.log("actionList is " + data.action_list);
        var actionList = document.getElementById('action_list');
        actionList.innerHTML = data.action_list;
        return data;
    }

    function updateGoalInfo(data) {
        console.log("goalInfo is: ")
        console.log(data.goal);
        if("category" in data.goal) {
            let goalCategory = document.getElementById('goal_cat');
            goalCategory.innerHTML = data.goal.category;
        } else {
            console.warn("category not in goalInfo");
        }

        if("description" in data.goal) {
            let goalDesc = document.getElementById('goal_desc');
            goalDesc.innerHTML = data.goal.description;
        } else {
            console.warn("description not in goalInfo");
        }

        if("last_step" in data.goal) {
            let lastStep = document.getElementById('goal_last_step');
            lastStep.innerHTML = data.goal['last_step'];
        } else {
            console.warn("last_step not in goalInfo");
        }

        return data;
    }

    function updateSceneFilename(data) {
        console.log("sceneFilename is " + data.scene);
        var sceneFilename = document.getElementById('scene_filename');
        sceneFilename.innerHTML = data.scene;
        return data;
    }

    function updateStepNumber(data) {
        console.log("stepNumber is " + data.step);
        var stepNumber = document.getElementById('step_number');
        stepNumber.innerHTML = data.step;
        return data;
    }

    function updateSceneList(data) {
        var scenesString = ''

        data.scene_list.forEach(scene => {
            scenesString = scenesString.concat('<li>' + scene + '</li>')
        });

        var scenesList = document.getElementById('scenes_unordered_list');
        scenesList.innerHTML = scenesString;
        eventHandleScenes()

        return data;
    }

    function getValidCoordinate(coordValue, maxValue) {
        // Python API will only accept image coord values
        // within the range of 0 to (max height/width - 1)
        // sometimes screen clicking can give you a value
        // slightly outside of this range, resolve it here.
        if(coordValue < 0) {
            return 0
        } else if(coordValue >= maxValue) {
            return coordValue = maxValue - 1
        } else {
            return coordValue
        }
    }

    function updateImageCoords(e) {
        let xValueMax = 600
        let yValueMax = 400
        let xValue = getValidCoordinate(e.offsetX, xValueMax)
        let yValue = getValidCoordinate(e.offsetY, yValueMax)

        params = {
            "objectImageCoordsX": xValue,
            "objectImageCoordsY": yValue
        }
        console.log("Image coords are: (x: " + xValue + ", y: " + yValue+ ")");
        var imageCoordX = document.getElementById('image_coord_x');
        imageCoordX.innerHTML = xValue;
        var imageCoordY = document.getElementById('image_coord_y');
        imageCoordY.innerHTML = yValue;
        return params;
    }

    function clearImageCoordinates(data) {
        console.log("Scene has been reset, resetting image coordinates... ")
        params = {
            "objectImageCoordsX": 300,
            "objectImageCoordsY": 200
        }
        document.getElementById('image_coord_x').innerHTML = 300
        document.getElementById('image_coord_y').innerHTML = 200

        return data;
    }

    // If the applicable action is triggered, checks any related input
    // fields to ensure the values make sense.
    function passesValidation(actionKey) {
        let errorMsg = document.getElementById("validation_errors")

        let amountVal = document.getElementById("amount").value
        if(['1', '2'].includes(actionKey) && (amountVal > 1 || amountVal < 0)) {
            errorMsg.innerHTML = "For OpenObject/CloseObject, the value " +
            "for 'amount' must be between 0 and 1."
            return false;
        }

        // if Push/PullObject, make sure force value is
        // between 0 and 1, for Torque, make sure its -1 to 1
        let forceVal = document.getElementById("force").value

        if(['5', '6'].includes(actionKey) && (forceVal > 1 || forceVal < 0)) {
            errorMsg.innerHTML = "For PushObject/PullObject, the value " +
            "for 'force' must be between 0 and 1."
            return false;
        }

        if(actionKey == '8' && (forceVal > 1 || forceVal < -1)) {
            errorMsg.innerHTML = "For TorqueObject, the value " +
            "for 'force' must be between -1 and 1."
            return false;
        }

        let lateral = document.getElementById("lateral").value
        let straight = document.getElementById("straight").value

        if(actionKey == "M" || actionKey == "m") {
            if (['-1', '0', '1'].includes(lateral) == false) {
                errorMsg.innerHTML = "For MoveObject, the value " +
                "for 'lateral' must be either -1, 0, or 1."
                return false;
            }

            if((['-1', '0', '1'].includes(straight)) == false) {
                errorMsg.innerHTML = "For MoveObject, the value " +
                "for 'straight' must be either -1, 0, or 1."
                return false;
            }
        }

        errorMsg.innerHTML = ""
        return true;
    }

    // listener for click
    document.getElementById('unityimg').onclick = function(e){
        updateImageCoords(e)
    }

    // ---------------------------------------------------------
    // Handle Key strokes (navigation)
    window.addEventListener('keydown', this.process_key, false);

    function process_key(e) {
        if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey || (arrowKeys.includes(e.key))) {
            return;
        }
        if (processingKeypress) {
            console.log('Currently processing keypress, ignoring new input.')
            return;
        }

        hasValidInput = passesValidation(e.key)

        if (!hasValidInput) {
            console.log('Input values are not valid, returning without ' +
            'processing action.')
            return;
        }

        if(e.key == 'q' || e.key == 'Q') {
            alert("EndScene is not supported. Please select a new scene from the " + 
            "left to change scenes instead, or close the browser if you are finished.");
            return;
        }

        if(actionKeysWithParams.includes(e.key)) {
            if(Object.keys(params).length === 0) {
                alert("Image coordinates are required for your selected action. " +
                "Please select image coordinates by clicking a point on the " +
                "scene image you would like to use.");
                return;
            }
        }
        processingKeypress = true
        loadingSpinner(true)

        fetch("{{url_for('handle_keypress')}}",
            {method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "keypress": JSON.stringify(e.key),
                "objectImageCoordsX": params.objectImageCoordsX,
                "objectImageCoordsY": params.objectImageCoordsY,
                "amount": document.getElementById("amount").value,
                "force": document.getElementById("force").value,
                "clockwise": document.getElementById("clockwise").checked,
                "lateral": document.getElementById("lateral").value,
                "straight": document.getElementById("straight").value
            })
            })
            .then(parseJsonResponse)
            .then(updateStepNumber)
            .then(updateImage)
            .then(function() {
                processingKeypress = false
                loadingSpinner(false)
            });

    }

    function loadingSpinner(loading=true) {
        if(loading) {
            document.getElementById("loading-spinner").style.display = "block"
        } else {
            document.getElementById("loading-spinner").style.display = "none"
        }
    }

    function updateImage(data) {
        console.log("image is " + data.image);
        var imgref = document.getElementById('unityimg');
        imgref.src = data.image;
        return data;
    }


</script>
</body>
</html>
